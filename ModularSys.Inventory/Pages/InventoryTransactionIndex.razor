@page "/inventory-transactions"
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@using ModularSys.Data.Common.Db
@using ModularSys.Inventory.Interface
@using ModularSys.Data.Common.Entities.Inventory
@using ModularSys.Inventory.Services
@inject IInventoryService InventoryService

<MudContainer MaxWidth="MaxWidth.False" Class="pa-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
        <MudText Typo="Typo.h6">Purchase Orders</MudText>
    </MudStack>

    <MudTable Items="@_transactions"
              Hover="true"
              Dense="true"
              Bordered="true"
              Striped="true"
              Class="w-100">

        <HeaderContent>
            <MudTh>Product ID</MudTh>
            <MudTh>Change</MudTh>
            <MudTh>Amount</MudTh>
            <MudTh>Type</MudTh>
            <MudTh>Date</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd>@context.ProductId</MudTd>
            <MudTd>@context.QuantityChange</MudTd>
            <MudTd>@context.Amount.ToString("₱#,##0.00")</MudTd>
            <MudTd>@context.TransactionType</MudTd>
            <MudTd>@context.TransactionDate.ToString("MMM dd, yyyy HH:mm")</MudTd>
        </RowTemplate>

        <NoRecordsContent>
            <MudText Color="Color.Secondary">No transactions found.</MudText>
        </NoRecordsContent>
    </MudTable>
</MudContainer>

@code {
    private List<InventoryTransaction> _transactions = new();

    protected override async Task OnInitializedAsync()
    {
        _transactions = (await InventoryService.GetAllAsync()).ToList();
    }

    private async Task<List<InventoryTransaction>> GetAllTransactionsAsync()
    {
        // If you want to show all transactions, not just per product
        var db = InventoryService as InventoryService;
        var context = typeof(InventoryService)
            .GetField("_db", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance)
            ?.GetValue(db) as InventoryDbContext;

        return await context.InventoryTransactions
            .OrderByDescending(t => t.TransactionDate)
            .ToListAsync();
    }
}
